<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - Distributed Inventory</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h2>Distributed Inventory</h2>
            <div class="nav-links">
                <a href="login.html?type=admin">Admin</a>
                <a href="login.html?type=customer">Customer</a>
                <button onclick="logout()" class="btn-link">Logout</button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <h1 class="page-title">Shop</h1>
        <div class="shop-dashboard">
            <!-- Left Card: Items -->
            <div class="shop-card">
                <div class="shop-card-header">
                    <h2>Items</h2>
                    <div class="shop-card-actions">
                        <span class="available-products-text">Available Products</span>
                        <button onclick="loadInventory()" class="btn btn-secondary btn-sm">Refresh</button>
                    </div>
                </div>
                <div class="items-table-container">
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="items-table-body">
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 2rem;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Right Card: Cart -->
            <div class="shop-card">
                <h2>Cart</h2>
                <div id="cart-items" class="cart-items-list"></div>
                <button onclick="checkout()" class="btn btn-primary btn-gradient btn-block" id="checkout-btn" disabled>Checkout (Buy)</button>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <p>Â© 2025 Distributed Inventory</p>
    </footer>
    
    <script src="app.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html?type=customer';
        }
        
        // Note: username-display element was removed from navbar, so this is safe to skip
        const usernameDisplay = document.getElementById('username-display');
        if (usernameDisplay) {
            usernameDisplay.textContent = localStorage.getItem('username');
        }
        
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        let inventory = [];
        
        // Load inventory on page load
        loadInventory();
        updateCartDisplay();
        
        function loadInventory() {
            const tbody = document.getElementById('items-table-body');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem;">Loading...</td></tr>';
            
            getInventory().then(data => {
                console.log('Inventory data:', data);
                if (data.success && data.items) {
                    inventory = data.items;
                    displayProducts(data.items);
                } else {
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 2rem; color: #fbbf24;">Error: ${data.message || 'Failed to load products'}</td></tr>`;
                    console.error('Failed to load inventory:', data);
                }
            }).catch(error => {
                console.error('Error loading inventory:', error);
                tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 2rem; color: #fbbf24;">Connection error. Please check if the server is running.</td></tr>`;
            });
        }
        
        function displayProducts(items) {
            const tbody = document.getElementById('items-table-body');
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem;">No products available</td></tr>';
                return;
            }
            
            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.product}</td>
                    <td>${item.quantity}</td>
                    <td>
                        <button onclick="addToCart('${item.product}', ${item.quantity})" 
                                class="btn btn-primary btn-sm" 
                                ${item.quantity === 0 ? 'disabled' : ''}>
                            Add
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function addToCart(product, maxQuantity) {
            // Add 1 item by default (matching the screenshot behavior)
            const quantity = 1;
            
            if (maxQuantity === 0) {
                alert('Item is out of stock');
                return;
            }
            
            const existingItem = cart.find(item => item.product === product);
            if (existingItem) {
                if (existingItem.quantity + quantity > maxQuantity) {
                    alert(`Cannot add more. Only ${maxQuantity} available total.`);
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                cart.push({ product, quantity });
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
        }
        
        function updateCartDisplay() {
            const cartItemsDiv = document.getElementById('cart-items');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<p style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.7);">Your cart is empty</p>';
                checkoutBtn.disabled = true;
                return;
            }
            
            checkoutBtn.disabled = false;
            cartItemsDiv.innerHTML = cart.map((item, index) => `
                <div class="cart-item-row">
                    <span>${item.product} x ${item.quantity}</span>
                    <button onclick="removeFromCart(${index})" class="btn btn-secondary btn-sm">Remove</button>
                </div>
            `).join('');
        }
        
        function removeFromCart(index) {
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
        }
        
        async function checkout() {
            if (cart.length === 0) {
                alert('Cart is empty');
                return;
            }
            
            if (!confirm('Confirm purchase?')) {
                return;
            }
            
            const result = await purchaseItems(cart);
            
            if (result.success) {
                const failed = result.results.filter(r => !r.success);
                if (failed.length > 0) {
                    alert('Some items failed: ' + failed.map(f => `${f.product}: ${f.message}`).join(', '));
                } else {
                    alert('Purchase successful!');
                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartDisplay();
                    loadInventory();
                }
            } else {
                alert('Purchase failed: ' + (result.message || 'Unknown error'));
            }
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>

